// Supabase配置 - 需要替换成您的实际信息
const supabaseUrl = 'https://您的项目.supabase.co';
const supabaseKey = '您的anon公开密钥';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    let userId = urlParams.get('userid');
    
    if (!userId) {
        showUserIdInput();
        return;
    }
    
    loadUserData(userId);
    
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => console.log('SW registered'))
            .catch(error => console.log('SW registration failed'));
    }
});

function showUserIdInput() {
    document.body.innerHTML = `
        <div class="weui-msg">
            <div class="weui-msg__icon-area">
                <i class="weui-icon-info-circle weui-icon_msg"></i>
            </div>
            <div class="weui-msg__text-area">
                <h2 class="weui-msg__title">请输入用户ID</h2>
                <p class="weui-msg__desc">请向管理员获取您的专属用户ID</p>
            </div>
            <div class="weui-msg__opr-area">
                <div class="weui-cells weui-cells_form">
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <input class="weui-input" type="text" id="inputUserId" placeholder="请输入用户ID">
                        </div>
                    </div>
                </div>
                <p class="weui-btn-area">
                    <a href="javascript:void(0)" class="weui-btn weui-btn_primary" onclick="submitUserId()">确定</a>
                </p>
            </div>
        </div>
    `;
}

function submitUserId() {
    const userId = document.getElementById('inputUserId').value.trim();
    if (userId) {
        window.location.href = `?userid=${encodeURIComponent(userId)}`;
    } else {
        alert('请输入用户ID');
    }
}

async function loadUserData(userId) {
    try {
        showLoading('加载用户信息...');
        
        const { data: userData, error } = await supabase
            .from('points_account')
            .select('*')
            .eq('user_id', userId)
            .single();
            
        if (error) {
            if (error.code === 'PGRST116') {
                throw new Error('用户不存在，请检查用户ID是否正确');
            }
            throw error;
        }
        
        updateUserInterface(userData);
        await loadUserRecords(userId);
        
    } catch (error) {
        console.error('加载用户数据失败:', error);
        showError(error.message);
    } finally {
        hideLoading();
    }
}

function updateUserInterface(userData) {
    document.getElementById('userName').textContent = userData.user_name || '会员';
    document.getElementById('userId').textContent = `ID: ${userData.user_id}`;
    document.getElementById('totalPoints').textContent = formatNumber(userData.total_points);
    document.getElementById('withdrawable').textContent = formatNumber(userData.withdrawable || 0);
    document.getElementById('userLevel').textContent = `V${userData.level || 0}`;
    
    const released = userData.withdrawable || 0;
    const totalRelease = userData.total_points * 0.003;
    const progress = totalRelease > 0 ? (released / totalRelease) * 100 : 0;
    
    document.getElementById('progressBar').style.width = `${Math.min(progress, 100)}%`;
    document.getElementById('progressText').textContent = `${Math.round(progress)}%`;
    document.getElementById('releasedAmount').textContent = formatNumber(released);
    document.getElementById('totalRelease').textContent = formatNumber(totalRelease);
}

async function loadUserRecords(userId) {
    try {
        const { data: records, error } = await supabase
            .from('points_log')
            .select('*')
            .eq('user_id', userId)
            .order('created_at', { ascending: false })
            .limit(10);
            
        if (error) throw error;
        
        updateRecordsList(records);
        
    } catch (error) {
        console.error('加载记录失败:', error);
        document.getElementById('recordsList').innerHTML = 
            '<div class="weui-loadmore weui-loadmore_line"><span class="weui-loadmore__tips">加载记录失败</span></div>';
    }
}

function updateRecordsList(records) {
    const recordsList = document.getElementById('recordsList');
    
    if (!records || records.length === 0) {
        recordsList.innerHTML = '<div class="weui-loadmore weui-loadmore_line"><span class="weui-loadmore__tips">暂无记录</span></div>';
        return;
    }
    
    let html = '';
    records.forEach(record => {
        const amountClass = record.amount >= 0 ? 'positive' : 'negative';
        const typeText = getRecordTypeText(record.type);
        const timeText = formatTime(record.created_at);
        
        html += `
            <div class="record-item">
                <div>
                    <div class="record-type">${typeText} - ${record.remark || ''}</div>
                    <div class="record-time">${timeText}</div>
                </div>
                <div class="record-amount ${amountClass}">
                    ${record.amount >= 0 ? '+' : ''}${formatNumber(record.amount)}
                </div>
            </div>
        `;
    });
    
    recordsList.innerHTML = html;
}

function formatNumber(num) {
    return Number(num).toFixed(2);
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    return `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
}

function getRecordTypeText(type) {
    const types = {
        1: '奖励',
        2: '释放',
        3: '提现',
        4: '其他'
    };
    return types[type] || '交易';
}

function showShare() {
    document.getElementById('sharePanel').classList.add('weui-actionsheet__toggle');
}

function hideShare() {
    document.getElementById('sharePanel').classList.remove('weui-actionsheet__toggle');
}

function copyLink() {
    const link = window.location.href;
    navigator.clipboard.writeText(link).then(() => {
        alert('链接已复制到剪贴板');
        hideShare();
    }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = link;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('链接已复制');
        hideShare();
    });
}

function showQRCode() {
    const link = window.location.href;
    hideShare();
    alert('当前链接: ' + link + '\n\n您可以用微信扫描下面的二维码：\n(请使用二维码生成工具为这个链接生成二维码)');
}

function showLoading(message) {
    document.body.style.opacity = '0.7';
    document.body.style.pointerEvents = 'none';
}

function hideLoading() {
    document.body.style.opacity = '1';
    document.body.style.pointerEvents = 'auto';
}

function showError(message) {
    alert('错误: ' + message);
    showUserIdInput();
}

function showRecords() {
    alert('已显示所有记录');
}